<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘½è¿ç½—ç›˜ | å…«å­— x MBTI æ·±åº¦è§£ç </title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #10b981; --bg: #0f172a; --card-bg: #1e293b; --text: #e2e8f0; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; }
        .container { max-width: 700px; margin: 0 auto; }
        
        h1 { text-align: center; background: linear-gradient(to right, #34d399, #3b82f6); -webkit-background-clip: text; color: transparent; font-size: 2rem; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #94a3b8; font-size: 0.9em; margin-bottom: 30px; }

        .card { background: var(--card-bg); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); border: 1px solid #334155; }
        
        label { display: block; color: #94a3b8; font-size: 0.85rem; margin-bottom: 8px; margin-top: 15px; }
        input, select { width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: var(--primary); }

        button { 
            width: 100%; padding: 16px; margin-top: 25px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
        }
        button:disabled { opacity: 0.7; cursor: wait; }

        /* æ’ç›˜è¡¨æ ¼ */
        .bazi-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; background: #0f172a; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .pillar-name { color: #64748b; font-size: 0.8rem; }
        .gan-zhi { font-size: 1.1rem; font-weight: bold; color: #e2e8f0; }

        /* AI å†…å®¹ */
        .markdown-body { color: #cbd5e1; font-size: 1rem; line-height: 1.8; }
        .markdown-body h3 { color: #34d399; margin-top: 25px; border-bottom: 1px solid #334155; padding-bottom: 8px; }
        .markdown-body strong { color: #fbbf24; }
        
        .loading { text-align: center; color: #94a3b8; padding: 20px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”® å‘½è¿ç½—ç›˜</h1>
    <p class="subtitle">å…«å­—å…ˆå¤©è“å›¾ Ã— MBTI åå¤©äººæ ¼</p>
    
    <div class="card">
        <label>ğŸ“… å‡ºç”Ÿæ—¥æœŸ (å…¬å†/é˜³å†)</label>
        <input type="datetime-local" id="birthDate" value="2003-07-17T09:50">
        
        <label>ğŸ“ å‡ºç”Ÿåœ°ç‚¹ (åŸå¸‚)</label>
        <input type="text" id="birthCity" placeholder="ä¾‹å¦‚ï¼šæ²³å—çœéƒ‘å·å¸‚ (ç”¨äºçœŸå¤ªé˜³æ—¶æ ¡æ­£)" value="æ²³å—çœéƒ‘å·å¸‚">

        <label>ğŸ§  MBTI äººæ ¼ç±»å‹</label>
        <select id="mbti">
            <optgroup label="å®ˆæŠ¤è€… (SJ)">
                <option value="ISTJ">ISTJ - ç‰©æµå¸ˆ (ä¸¥è°¨è´Ÿè´£)</option>
                <option value="ISFJ">ISFJ - å®ˆå«è€… (æ¸©æš–å®ˆæŠ¤)</option>
                <option value="ESTJ">ESTJ - æ€»ç»ç† (é«˜æ•ˆæ‰§è¡Œ)</option>
                <option value="ESFJ">ESFJ - æ‰§æ”¿å®˜ (çƒ­æƒ…åŠ©äºº)</option>
            </optgroup>
            <optgroup label="æ¢é™©å®¶ (SP)">
                <option value="ISTP">ISTP - é‰´èµå®¶ (å†·é™ç†æ€§)</option>
                <option value="ISFP">ISFP - æ¢é™©å®¶ (çµåŠ¨è‰ºæœ¯)</option>
                <option value="ESTP">ESTP - ä¼ä¸šå®¶ (æ´»åœ¨å½“ä¸‹)</option>
                <option value="ESFP">ESFP - è¡¨æ¼”è€… (å¤©ç”Ÿèšå…‰)</option>
            </optgroup>
            <optgroup label="å¤–äº¤å®¶ (NF)">
                <option value="INFJ">INFJ - æå€¡è€… (æ·±é‚ƒæ´å¯Ÿ)</option>
                <option value="INFP" selected>INFP - è°ƒåœè€… (æ²»æ„ˆè¯—äºº)</option>
                <option value="ENFJ">ENFJ - ä¸»äººå…¬ (é­…åŠ›é¢†è¢–)</option>
                <option value="ENFP">ENFP - ç«é€‰è€… (è‡ªç”±çµé­‚)</option>
            </optgroup>
            <optgroup label="åˆ†æå®¶ (NT)">
                <option value="INTJ">INTJ - å»ºç­‘å¸ˆ (æˆ˜ç•¥æ€ç»´)</option>
                <option value="INTP">INTP - é€»è¾‘å­¦å®¶ (è¿½æ±‚çœŸç†)</option>
                <option value="ENTJ">ENTJ - æŒ‡æŒ¥å®˜ (è¿ç­¹å¸·å¹„)</option>
                <option value="ENTP">ENTP - è¾©è®ºå®¶ (æ™ºåŠ›æŒ‘æˆ˜)</option>
            </optgroup>
        </select>

        <button onclick="startAnalysis()" id="btn">ğŸš€ å¼€å¯å¤©æœºè§£ç </button>
    </div>

    <div id="result" class="card" style="display:none;">
        <div style="margin-bottom: 20px;">
            <div style="text-align:center; color:#94a3b8; font-size:0.9rem;">æ‚¨çš„å‘½ç›˜ç»“æ„</div>
            <div class="bazi-box" id="baziChart"></div>
        </div>
        
        <div id="loading" class="loading">
            <p>â˜ï¸ æ­£åœ¨è¿æ¥å¤©æœºç³»ç»Ÿ...</p>
            <p>å¤§å¸ˆæ­£åœ¨ç„šé¦™æ¨æ¼”ï¼Œè¯·è€å¿ƒç­‰å¾… 10-20 ç§’...</p>
        </div>

        <div id="aiContent" class="markdown-body"></div>
    </div>
</div>

<script>
    async function startAnalysis() {
        const dateStr = document.getElementById('birthDate').value;
        const city = document.getElementById('birthCity').value;
        const mbti = document.getElementById('mbti').value;

        if(!dateStr || !city) return alert("è¯·å®Œæ•´å¡«å†™ä¿¡æ¯");

        // 1. æœ¬åœ°æ’ç›˜ (ä»…ç”¨äºå±•ç¤º)
        const d = new Date(dateStr);
        const solar = Solar.fromYmdHms(d.getFullYear(), d.getMonth()+1, d.getDate(), d.getHours(), d.getMinutes(), 0);
        const lunar = solar.getLunar();
        const bazi = lunar.getBaZi();
        
        let html = '';
        const pillars = ['å¹´æŸ±', 'æœˆæŸ±', 'æ—¥æŸ±', 'æ—¶æŸ±'];
        bazi.forEach((p, i) => {
            html += `<div><div class="pillar-name">${pillars[i]}</div><div class="gan-zhi">${p}</div></div>`;
        });
        document.getElementById('baziChart').innerHTML = html;

        // 2. ç•Œé¢åˆ‡æ¢
        document.getElementById('result').style.display = 'block';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('aiContent').style.display = 'none';
        document.getElementById('btn').disabled = true;
        document.getElementById('btn').innerText = "â³ æ¨æ¼”ä¸­...";

        // 3. è¯·æ±‚æˆ‘ä»¬è‡ªå·±çš„åç«¯ (api/analyze)
        try {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    birthDate: dateStr, 
                    birthCity: city, 
                    mbti: mbti 
                })
            });

            const data = await res.json();
            
            if (data.error) throw new Error(data.error);

            // 4. æ˜¾ç¤º AI ç»“æœ
            const text = data.choices[0].message.content;
            document.getElementById('aiContent').innerHTML = marked.parse(text);
            document.getElementById('aiContent').style.display = 'block';

        } catch (e) {
            alert("æ¨æ¼”å¤±è´¥ï¼š" + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btn').disabled = false;
            document.getElementById('btn').innerText = "ğŸš€ å†æ¬¡æ¨æ¼”";
        }
    }
</script>
</body>
</html>
