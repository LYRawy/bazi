<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å‘½ç†å¤§å¸ˆ - çœŸå®æ·±åº¦ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #8b5cf6; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: 'PingFang SC', sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        h1 { text-align: center; color: #4c1d95; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #6b7280; font-size: 0.9em; margin-bottom: 30px; }

        /* è¾“å…¥æ¡†æ ·å¼ */
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9rem; color: #374151; }
        input, select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 16px; font-size: 16px; box-sizing: border-box; }
        
        /* æŒ‰é’®ç‰¹æ•ˆ */
        button { 
            width: 100%; padding: 16px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); 
            color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; 
            transition: transform 0.1s; display: flex; align-items: center; justify-content: center;
        }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }

        /* API Key è¾“å…¥æ¡†ç‰¹åˆ«æ ·å¼ */
        .api-box { background: #eff6ff; border: 1px dashed #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .api-note { font-size: 12px; color: #666; margin-top: -10px; margin-bottom: 15px; }

        /* æ’ç›˜ç»“æœ */
        .bazi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; margin-top: 20px; }
        .pillar { background: #f9fafb; padding: 10px 5px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .gan { font-size: 1.2rem; color: #dc2626; font-weight: bold; }
        .zhi { font-size: 1.2rem; font-weight: bold; }
        .god { font-size: 0.7rem; color: #9ca3af; }

        /* AI å›å¤åŒºåŸŸ */
        #resultSection { display: none; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #8b5cf6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Markdown å†…å®¹æ ·å¼ */
        .markdown-body { font-size: 1rem; color: #333; line-height: 1.8; }
        .markdown-body h2 { border-bottom: 2px solid #8b5cf6; padding-bottom: 10px; margin-top: 30px; color: #4c1d95; }
        .markdown-body h3 { color: #6d28d9; margin-top: 20px; }
        .markdown-body strong { color: #b91c1c; background: #fee2e2; padding: 0 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”® å‘½è¿è§£ç  v3.0</h1>
    <p class="subtitle">DeepSeek æ·±åº¦é©±åŠ¨ Â· èåˆå…«å­—ä¸äººæ ¼å¿ƒç†å­¦</p>
    
    <div class="card">
        <div class="api-box">
            <label>ğŸ”‘ è¯·è¾“å…¥ä½ çš„ DeepSeek API Key</label>
            <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
            <p class="api-note">ä¸ä¼šä¿å­˜ä½ çš„ Keyï¼Œä»…ç”¨äºå½“å‰é¡µé¢è¯·æ±‚ AIã€‚</p>
        </div>

        <label>ğŸ“… å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="datetime-local" id="birthDate" value="2003-07-17T09:50">
        
        <label>ğŸ§  MBTI ç±»å‹</label>
        <select id="mbti">
            <option value="INFP">INFP (è°ƒåœè€…)</option>
            <option value="INFJ">INFJ (æå€¡è€…)</option>
            <option value="ENFP">ENFP (ç«é€‰è€…)</option>
            <option value="INTJ">INTJ (å»ºç­‘å¸ˆ)</option>
            <option value="ENTP">ENTP (è¾©è®ºå®¶)</option>
            </select>

        <button onclick="startAnalysis()" id="btn">
            <span id="btnText">âœ¨ å¬å”¤ AI å¤§å¸ˆè¿›è¡Œæ·±åº¦æ¨æ¼”</span>
        </button>
    </div>

    <div id="resultSection" class="card">
        <div style="border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
            <h3>ğŸ“Š ä½ çš„å‘½ç›˜ç»“æ„</h3>
            <div class="bazi-grid" id="baziChart">
                </div>
            <p style="text-align:center; margin-top:10px; font-size:0.9rem; color:#666;">
                æ—¥ä¸»ï¼š<span id="dayMaster" style="font-weight:bold; color:#000;">--</span> 
                | äº”è¡Œï¼š<span id="dayElement" style="font-weight:bold; color:#000;">--</span>
            </p>
        </div>

        <div id="loading" class="loading">
            <div class="loader"></div>
            <p>æ­£åœ¨è¿æ¥å¤©æœº... AI æ­£åœ¨æ’°å†™ä¸‡å­—è¯¦æ‰¹...</p>
            <p style="font-size: 12px;">(å¤§æ¦‚éœ€è¦ 10-20 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…)</p>
        </div>
        
        <div id="aiContent" class="markdown-body" style="display:none"></div>
    </div>
</div>

<script>
    async function startAnalysis() {
        // 1. è·å–è¾“å…¥
        const apiKey = document.getElementById('apiKey').value.trim();
        const dateStr = document.getElementById('birthDate').value;
        const mbti = document.getElementById('mbti').value;

        if (!apiKey) return alert("è¯·å…ˆå¡«å…¥ API Keyï¼Œå¦åˆ™ AI æ— æ³•å·¥ä½œï¼");
        if (!dateStr) return alert("è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ");

        // 2. ç•Œé¢è¿›å…¥åŠ è½½çŠ¶æ€
        document.getElementById('btn').disabled = true;
        document.getElementById('btnText').innerText = "ğŸ”® æ­£åœ¨æ¨æ¼”ä¸­...";
        document.getElementById('resultSection').style.display = 'block';
        document.getElementById('loading').style.display = 'block';
        document.getElementById('aiContent').style.display = 'none';

        // 3. è®¡ç®—å…«å­— (æœ¬åœ°è®¡ç®—)
        const d = new Date(dateStr);
        const solar = Solar.fromYmdHms(d.getFullYear(), d.getMonth()+1, d.getDate(), d.getHours(), d.getMinutes(), 0);
        const lunar = solar.getLunar();
        const bazi = lunar.getBaZi();
        
        // æ¸²æŸ“æ’ç›˜ UI
        renderBazi(bazi);

        // 4. å‡†å¤‡ç»™ AI çš„ Prompt (æç¤ºè¯)
        const dayMaster = bazi[2].substring(0, 1); // æ—¥å¹²
        const monthZhi = bazi[1].substring(1, 2); // æœˆä»¤
        
        const prompt = `
            æˆ‘æ˜¯ä¸€ä¸ª${mbti}ç±»å‹çš„äººã€‚
            æˆ‘çš„å…«å­—æ’ç›˜å¦‚ä¸‹ï¼š
            å¹´æŸ±ï¼š${bazi[0]}
            æœˆæŸ±ï¼š${bazi[1]}
            æ—¥æŸ±ï¼š${bazi[2]} (æ—¥ä¸»ä¸º${dayMaster})
            æ—¶æŸ±ï¼š${bazi[3]}
            
            è¯·ä½ æ‰®æ¼”ä¸€ä½ç²¾é€šã€Šä¸‰å‘½é€šä¼šã€‹ä¸è£æ ¼å¿ƒç†å­¦çš„èµ„æ·±å¤§å¸ˆï¼Œä¸ºæˆ‘å†™ä¸€ä»½â€œæ€§æ ¼ä¸å‘½è¿æ·±åº¦åˆ†ææŠ¥å‘Šâ€ã€‚
            è¦æ±‚ï¼š
            1. è¯­æ°”è¦ä¸“ä¸šã€ç¥ç§˜ä½†å¯Œæœ‰åŒç†å¿ƒã€‚
            2. ç»“åˆæˆ‘çš„å…«å­—æ—¥ä¸»èƒ½é‡å’ŒMBTIæ€§æ ¼è¿›è¡Œäº¤å‰åˆ†æï¼ŒæŒ‡å‡ºæˆ‘çš„çŸ›ç›¾ç‚¹ã€‚
            3. ç¯‡å¹…è¦é•¿ï¼Œåˆ†è¿™å‡ ä¸ªç« èŠ‚ï¼šã€æ ¸å¿ƒæ€§æ ¼åº•è‰²ã€‘ã€ã€äº‹ä¸šä¸å¤©èµ‹åˆ†æã€‘ã€ã€æƒ…æ„Ÿä¸äººé™…å…³ç³»ã€‘ã€ã€æœªæ¥5å¹´è¿åŠ¿å»ºè®®ã€‘ã€‚
            4. ä½¿ç”¨ Markdown æ ¼å¼è¾“å‡ºï¼Œé‡ç‚¹è¯æ±‡åŠ ç²—ã€‚
        `;

        // 5. è°ƒç”¨ DeepSeek API
        try {
            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {"role": "system", "content": "ä½ æ˜¯ä¸€ä½ç²¾é€šå…«å­—å‘½ç†å’ŒMBTIçš„ä¸“å®¶ã€‚"},
                        {"role": "user", "content": prompt}
                    ],
                    stream: false
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            // 6. æˆåŠŸï¼æ¸²æŸ“ç»“æœ
            const aiText = data.choices[0].message.content;
            document.getElementById('aiContent').innerHTML = marked.parse(aiText); // Markdown è½¬ HTML
            document.getElementById('aiContent').style.display = 'block';
            
        } catch (error) {
            alert("å‡ºé”™äº†ï¼š" + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®å’ŒåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'none';
            document.getElementById('btn').disabled = false;
            document.getElementById('btnText').innerText = "âœ¨ å†æ¬¡æ¨æ¼”";
        }
    }

    function renderBazi(bazi) {
        const pillars = ['å¹´æŸ±', 'æœˆæŸ±', 'æ—¥æŸ±', 'æ—¶æŸ±'];
        let html = '';
        bazi.forEach((p, index) => {
            const gan = p.substring(0,1);
            const zhi = p.substring(1,2);
            html += `
                <div class="pillar">
                    <div class="god">${pillars[index]}</div>
                    <div class="gan">${gan}</div>
                    <div class="zhi">${zhi}</div>
                </div>
            `;
        });
        document.getElementById('baziChart').innerHTML = html;
        document.getElementById('dayMaster').innerText = bazi[2].substring(0,1);
        document.getElementById('dayElement').innerText = LunarUtil.WU_XING_GAN[bazi[2].substring(0,1)];
    }
</script>
</body>
</html>
